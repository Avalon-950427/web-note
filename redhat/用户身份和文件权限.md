## 用户身份和文件权限

#### 用户身份与能力

root 管理员(UID 为 0)在账号是在所有类 UNIX 系统中的超级用户,拥有最高的系统权限

| 用户身份  | UID       | 描述                                                                                |
| --------- | --------- | ----------------------------------------------------------------------------------- |
| root 用户 | 0         | 系统的管理员用户                                                                    |
| 系统用户  | 1-999     | 为避免因某个程序的漏洞被黑客提权至整台服务器,默认服务程序会有独立的系统用户负责运行 |
| 普通用户  | 1000 开始 | 由 root 账户创建的用于日常工作的用户                                                |

用户组是为了方便管理属于同一组用户,从而可以为组中的用户同意规划权限或指定任务

Linux 系统创建每个用户时,会自动创建于用户名相同的基本用户组,基本用户组只有一个人,如果该用户被归纳到其他用户组,其他用户组称为拓展用户组,一个账户只能有一个基本用户组,可以有多个拓展用户组

###### useradd 命令

useradd 命令用于创建新的用户，格式为“useradd [选项] 用户名”。  
useradd 命令创建账户时,默认的用户家目录被存放在/home 目录中,默认的 Shell 解释器为/bin/bash

| 参数 | 描述                                 |
| ---- | ------------------------------------ |
| -d   | 指定用户的家目录                     |
| -e   | 账户的到位时间,格式为 YYYY-MM-DD     |
| -u   | 指定该用户的默认 UID                 |
| -g   | 指定一个初始的用户基本组(必须已存在) |
| -G   | 指定一个或多个拓展用户组             |
| -N   | 不创建与用户同名的基本用户组         |
| -s   | 指定该用户的默认 Shell 解释器        |

```shell
useradd -d /home/linux -u 8888 -s /sbin/nologin linuxprobe // 家目录为/home/linux,uid为8888,bash解释器在/sbin/nologin,用户名称为linuxprobe
一旦解释器被是指为nologin,则用户不能登录到系统中
```

###### groupadd 命令

groupadd 命令用于创建用户组，格式为“groupadd [选项] 群组名”。

```shell
groupadd ronny // 创建一个叫ronny的用户组
```

###### usermod 命令

usermod 命令用于修改用户的属性，格式为“usermod [选项] 用户名”。

linux 中一切皆文件,因此修改用户也就是修改配置文件,用户的信息保存在/etc/passwd 中,可以直接修改其中的用户参数项目,也可以使用 usermod 命令修改用户信息

| 参数  | 描述                                                            |
| ----- | --------------------------------------------------------------- |
| -c    | 填写用户账户的备注信息                                          |
| -d -m | 参数 m 与 d 连用,可重新制定用户的家目录并自动把旧的数据转移过去 |
| -e    | 账户的到期时间,格式为 YYYY-MM-DD                                |
| -g    | 更变所属用户组                                                  |
| -G    | 更变扩展用户组                                                  |
| -L    | 锁定用户禁止其登录系统                                          |
| -U    | 解锁用户,允许其登录系统                                         |
| -s    | 变更默认终端                                                    |
| -u    | 修改用户的 UID                                                  |

###### passwd 命令

passwd 命令用于修改用户密码、过期时间、认证信息等，格式为“passwd [选项][用户名]”

普通用户只能用 passwd 修改自身密码,root 可以修改所以密码并且不需要验证旧密码,用户密码保存在/etc/shadow 中

| 参数    | 描述                                                    |
| ------- | ------------------------------------------------------- |
| -l      | 锁定用户,禁止其登录                                     |
| -u      | 解除锁定,允许用户登录                                   |
| --stdin | 允许通过标准输入修改用户密码,如 echo "NewPassWord"      | passwd --stdin Username |
| -d      | 是该用户可用空密码登录系统                              |
| -e      | 强制用户在下次登录时修改密码                            |
| -S      | 显示用户的密码是否被锁定,以及密码所采用的的加密算法名称 |

###### userdel 命令

userdel 命令用于删除用户，格式为“userdel [选项] 用户名”  
在执行操作时,用户的家目录默认会保留下来,可用-r 参数将其删除

| 参数 | 描述                       |
| ---- | -------------------------- |
| -f   | 强制删除用户               |
| -r   | 删除用户同时删除用户家目录 |

#### 文件权限与归属

**Linux 中的文件分类**
分类名称|标识符
---|---
-|普通文件  
d|目录文件
l|链接文件
b|块设备文件
c|字符设备文件
p|管道文件

**文件的 rwx**

- 可读 r4:能够读取文件的实际内容
- 可执行 x1:能运行一个脚本程序
- 可写 w2:可对文件增删改查

**目录的 rwx**

- 可读 r4:能够读取目录的文件列表
- 可写 w2:能够在目录内新增、删除、重命名文件
- 可执行 x1:能够进入目录

```shell
ls -l install.log
-rw-r--r-- 1 root root 34291 04-04 00:23 install.log
第一个-是文件类型
rw开始是访问权限
第一个root是文件所有者
第二个root是所属组
34291位文件占用磁盘大小的字节
04-04 00:23为最后一次修改时间
```

#### 文件的特殊权限

###### SUID

让命令的执行者临时获取到文件的所有者权限(仅对二进制文件有效)  
/etc/shadow 里存放的是账户的密码但普通成员都没有权限去读写这个文件,但是却可用 passwd 命令去修改账户密码

```shell
whereis passwd // /usr/bin/passwd,通过whereis命令去查询命令的路径
ls -l /usr/bin/passwd //-rwsr-xr-x,所以这个命令的执行者能临时获得文件所有者的权限
```

```shell
设置特殊权限SUID
chmod u+s 文件名
```

###### SGID

1. 让执行者临时获得文件所有组的权限(仅对二进制文件有效)
2. 让目录中新的文件的所有组,归属上级目录

chmod 权限 文件名称:修改文件权限

```shell
chmod 755 a.log
```

```shell
设置特殊权限SGID
chmod -R g+s 文件名
```

chown 用户名 : 用户组 文件名称:设置文件

###### SBID

让目录被的文件只能被文件所有者删除

```shell
设置特殊权限SBID
chmod -R o+t 文件名
```

#### 隐藏权限

###### chattr 命令

chattr 命令用于设置文件的隐藏权限，格式为“chattr [参数] 文件”。  
如果想要在文件上加某个隐藏功能,则需在命令后面加上"+参数",如果想要在文件上移除某个隐藏功能,则需要在命令后面加上"-参数"

| 参数 | 描述                                                                                       |
| ---- | ------------------------------------------------------------------------------------------ |
| i    | 无法对文件进行修改,若对目录设置了该参数,则仅能修改其子文件内容而不能添加子文件和删除子文件 |
| a    | 仅允许补充（追加）内容，无法覆盖/删除内容（Append Only）                                   |
| S    | 文件内容在变更后立即同步到硬盘（sync）                                                     |
| s    | 彻底从硬盘中删除，不可恢复（用 0 填充原文件所在硬盘区域）                                  |
| A    | 不再修改这个文件或目录的后访问时间（atime）                                                |
| b    | 不再修改文件或目录的存取时间                                                               |
| D    | 检查压缩文件中的错误                                                                       |
| d    | 使用 dump 命令备份时忽略本文件/目录                                                        |
| c    | 默认将文件或目录进行压缩                                                                   |
| u    | 当删除该文件后依然保留其在硬盘中的数据，方便日后恢复                                       |
| t    | 让文件系统支持尾部合并（tail-merging）                                                     |
| X    | 可以直接访问压缩文件中的内容                                                               |

###### lsattr 命令

lsattr 命令用于显示文件的隐藏权限，格式为“lsattr [参数] 文件”。

#### 文件访问控制列表

对文件或目录设置 ACL 就是针对指定用户或者用户组设置文件的操作权限

###### setfacl 命令

setfacl 命令用于管理文件的 ACL 规则，格式为“setfacl [参数] 文件名称”。文件的 ACL 提供的是所有者,所属组,其他人的读写执行权限之外的特殊控制权限,使用 setfacl 命令 可以针对单一用户或用户组、单一文件或目录来进行读/写/执行权限的控制。  
针对目录 文件需要使用-R 递归参数；针对普通文件则使用-m 参数；如果想要删除某个文件的 ACL， 则可以使用-b 参数。

```shell
setfacl -Rm u:avalon:rwx /root // 给avalon用户读写操作/root的权限
su avalon
cd /root
```

可通过 ls -l 来查看某个文件是否有 ACL 权限,若在权限后面的.变成+号,则文件有 ACL 权限

###### getfacl 命令

getfacl 命令用于显示文件上设置的 ACL 信息，格式为“getfacl 文件名称”。

#### su 命令与 sudo 服务

su 命令可以解决切换用户身份的需求，使得当前用户在不退出登录的情况下，顺畅地切 换到其他用户

```shell
su - avalon // -表示完全切换到新用户,即把环境变量也变更为新用户的相应信息,而不是保留原始的信息
```

sudo 命令用于给普通用户提供额外的权限来完成原本 root 管理员才能完成的任务，格式 为“sudo [参数] 命令名称”。
参数|描述
---|---
-h|列出帮助信息  
-l|列出当前用户可执行的命令  
-u 用户名或 UID 值|以指定的用户身份执行命令  
-k|清空密码的有效时间,下次执行 sudo 时需要再次进行密码验证  
-b|在后台执行指定的命令
-p|更改询问密码的提示语
